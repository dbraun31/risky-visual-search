---
title: 'Risky Visual Search - Choice Analysis'
author: 'Dave Braun'
date: 'December 13, 2022'
output:
  html_document:
    theme: flatly
    code_folding: hide
    df_print: paged
    toc: true
    includes:
      after_body: ../../../../html/footer.html
      in_header: ../../../../html/favicon.html
knit:
  (function(inputFile, encoding) {
    rmarkdown::render(inputFile,
    encoding = encoding,
    output_file = 'index.html')})
---


This document was last updated at `r Sys.time()`.

```{r include = FALSE}
library(tidyverse)
library(ggsci)
```


```{r}
d <- read.csv('../../../data/main.csv')
N <- length(unique(d$subject))
head(d)
```

Initial sample size is `r N`.


```{r}
d %>% 
  mutate(direction = recode(direction, `Easier than Reference` = 'Easier',
                          `Harder than Reference` = 'Harder')) %>% 
  group_by(subject, direction, magnitude, colors) %>% 
  summarize(ssd_ = mean(ssd)) %>% 
  group_by(direction, magnitude, colors) %>% 
  summarize(ssd = mean(ssd_), se = sd(ssd_) / sqrt(N)) %>% 
  ggplot(aes(x = direction, y = ssd)) + 
  geom_hline(yintercept = .5, linetype = 'dotted') +
  geom_bar(stat = 'identity', aes(fill = magnitude), position = position_dodge(width= .9), color = 'black') + 
  geom_errorbar(aes(ymin = ssd - se, ymax = ssd + se, group = magnitude), width = .5, position = position_dodge(width= .9)) + 
  ylim(0,1) + 
  facet_wrap(~colors) + 
  labs(
    x = 'Framing',
    y = 'Proportion Selection of Safe Deck',
    fill = 'Magnitude',
    caption = paste0('N = ', N, '.')
  ) + 
  scale_fill_manual(values = c(`Extreme` = 'grey', `Moderate` = 'white')) + 
  theme_bw() +
  theme(axis.ticks = element_blank(),
        panel.grid = element_blank(),
        strip.background = element_blank())
```

### Individual differences in direction effect

```{r}
m <- d %>% 
  group_by(subject, direction) %>% 
  summarize(ssd_ = mean(ssd)) %>% 
  group_by(direction) %>% 
  summarize(ssd = mean(ssd_))

d %>% 
  group_by(subject, direction) %>% 
  summarize(ssd = mean(ssd)) %>% 
  ggplot(aes(x = direction, y = ssd)) + 
  geom_violin(fill = 'steelblue', alpha = .2) + 
  geom_boxplot(fill = NA) + 
  geom_jitter(width = .05, alpha = .7) + 
  geom_line(aes(group = subject), linetype = 'dashed', alpha = .7) +
  ylim(0,1) +
  labs(
    x = 'Direction',
    y = 'Proportion Selection of Safe Option'
  ) + 
  theme_bw()

```



```{r}
library(ez)

ad <- d %>% 
  group_by(subject, direction, magnitude, colors) %>% 
  summarize(ssd_ = mean(ssd)) 

m1 <- ezANOVA(wid = subject, within = .(direction, magnitude),
              between = .(colors), dv = ssd_, detailed = TRUE, data = ad)
cbind(m1$ANOVA, data.frame(n2p = m1$ANOVA$SSn / (m1$ANOVA$SSn + m1$ANOVA$SSd)))
  
```

## Marginal means

```{r eval = FALSE}
d %>% 
  group_by(subject, direction, magnitude, timing) %>% 
  summarize(ssd_ = mean(ssd)) %>% 
  group_by(direction) %>% 
  summarize(ssd = mean(ssd_), se = sd(ssd_) / sqrt(N))

d %>% 
  group_by(subject, direction, magnitude, timing) %>% 
  summarize(ssd_ = mean(ssd)) %>% 
  group_by(magnitude) %>% 
  summarize(ssd = mean(ssd_), se = sd(ssd_) / sqrt(N))

d %>% 
  group_by(subject, direction, magnitude, timing) %>% 
  summarize(ssd_ = mean(ssd)) %>% 
  group_by(timing) %>% 
  summarize(ssd = mean(ssd_), se = sd(ssd_) / sqrt(N))
```



## Mixed modeling

```{r}
library(lme4)

d$direction_e <- ifelse(d$direction == 'Easier than Reference', -0.5, 0.5)

mm1 <- glmer(ssd ~ direction_e * colors + (1 + direction_e * colors | subject), data = d, family = binomial(link = 'logit'), nAGQ = 1)

mm2 <- glmer(ssd ~ direction_e * colors + (1 + direction_e + colors | subject), data = d, family = binomial(link = 'logit'), nAGQ = 1)

mm3 <- glmer(ssd ~ direction_e * colors + (1 | subject) + (0 + direction_e | subject), data = d, family = binomial(link = 'logit'), nAGQ = 1)

mm4 <- glmer(ssd ~ direction_e * colors + (1 | subject), data = d, family = binomial(link = 'logit'), nAGQ = 1)

anova(mm4, mm3)

mm <- mm3

```

### Hypothesis testing
```{r}
## hypothesis testing
mm2 <- glmer(ssd ~ colors + colors:direction_e  + (1 + direction_e | subject) , data = d, family = binomial(link = 'logit'), nAGQ = 1)
anova(mm, mm2)
summary(mm)
exp(fixef(mm))
exp(confint(mm, method = 'Wald'))
```
This data sucks smdh

### Prediction

```{r eval = FALSE}
easyPredCI <- function(model,newdata=NULL,alpha=0.05) {
    ## baseline prediction, on the linear predictor (logit) scale:
    pred0 <- predict(model,re.form=NA,newdata=newdata)
    ## fixed-effects model matrix for new data
    X <- model.matrix(formula(model,fixed.only=TRUE)[-2],newdata)
    beta <- fixef(model) ## fixed-effects coefficients
    V <- vcov(model)     ## variance-covariance matrix of beta
    pred.se <- sqrt(diag(X %*% V %*% t(X))) ## std errors of predictions
    ## inverse-link function
    linkinv <- family(model)$linkinv
    ## construct 95% Normal CIs on the link scale and
    ##  transform back to the response (probability) scale:
    crit <- -qnorm(alpha/2)
    linkinv(cbind(conf.low=pred0-crit*pred.se,
                  conf.high=pred0+crit*pred.se))
}


## prediction
## intervals from: https://stats.stackexchange.com/questions/147836/prediction-interval-for-lmer-mixed-effects-model-in-r
## dunno how to only get population-level prediction intervals from ^
#library(merTools)
test_data <- expand.grid(direction = unique(d$direction))
test_data$proba <- predict(mm1, re.form=NA, newdata = test_data, type='response')
test_data <- cbind(test_data, easyPredCI(mm1, newdata = test_data))
test_data %>% 
  ggplot(aes(x = direction, y = proba)) + 
  geom_bar(stat = 'identity') + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = .5) +
  ylim(0, 1) + 
  labs(
    x = 'Direction', 
    y = 'Probability of Selecting Safe Deck'
  ) + 
  theme_bw()
```














