<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <title>Braun Dissertation</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--<link rel='stylesheet' type='text/css' href='../../global_css/globalStyle.css?v=4'>-->
    <link rel='stylesheet' type='text/css' href='../../global_css/globalStyle_decks.css?v=1'>
    <link rel='stylesheet' type='text/css' href='../style/exp2Style.css?v=1'>
    <link rel='stylesheet' type='text/css' href='../../global_css/deckStyle.css'>
    <script src='../js/exp2Functions.js?v=2'></script>
    <script src='../../global_js/globalFunctions_decks.js?v=1'></script>
    <script src='../../global_js/TimTurkTools.js'></script>
    <script src='../../global_js/jquery-bbq.js'></script>
    <script src='../../global_js/logistic_regression.js'></script>

<script>

$(document).ready(function(){
// id params
var survey_code = getParam('survey-code', '');
var subject_id = getParam('subject-id', '');

var pilot = getParam('pilot', '');


// GLOBAL VARS
// thresholds
// 17 cued responses per choice
var responseThreshold = 7;
// randomly select 4 conditions without replacement across 4 consecutive choices
var trialThreshold = 4;
// how many times do all conditions repeat
var cycleThreshold = 10;

// parse url args
var taskCueCode = urlArgsToVar('taskCueCode')=='NONE'? createTaskCue() : urlArgsToVar('taskCueCode');
var clientCueCode = createClientCueText(taskCueCode);
var experimentStartTime = urlArgsToVar('experimentStartTime');
var phaseStartTime = Date.now();

// Other global vars
var cycleCount = 0;
var trialCount = 0;
var cycleTrialCount = 0;
var responseCount = 0;
var cuedRsi = 200;
var choiceRsi = 500;
var prevTaskColor = '';
var experimentName = 'experiment2';
var phase = 'main';
var rtStartTime = new Date();
var error = 0;
var rt_window = -99;
var chosenDeckLocation = '';
var selectionKey = 0;
var trialStruct = new Array();
var deckCode = {};
var startTime = new Date();
var cuedRt = new Date();
var blockTime = new Date();
var phaseStartTime = new Date();
var activeSeparator = '';
var cuedResponseKey = '';
var choiceResponseKey = '';

var vid = document.getElementById('tutorial');
var instructionsReceived = 0;
vid.onended = function() {
    instructionsReceived = 1;
}


// control conditions
var ref = 0.75;
var conditionOrder = new Array();
var direction = '';
var magnitude = '';

// get effort calibration parameters
var b0 = getParam('b0', 1.086957);
var b1 = getParam('b1', -0.000434783);


//DEVELOPMENT
// var vid = document.getElementById('tutorial');

// serve client facing controls string
var controlsString = '<p>The blue task is: ' + clientCueCode['blue'] + (clientCueCode['blue'] == 'Magnitude'? ' (d: low, f: high)': ' (j: odd, k: even)') +'</p><p>The red task is: ' + clientCueCode['red'] + (clientCueCode['red'] == 'Magnitude'? ' (d: low, f: high)' : ' (j: odd, k: even)') +'</p>';

// set initial state
$('#detailSlide').hide();
$('#controlsFill').html(controlsString);
$('#keyRemindSlide').hide();
$('.choiceSlide').hide();
$('.stimSlide').hide();
$('#blockTransitionSlide').hide();
$('#development').hide();
$('#botCatcher').hide();

if (subject_id.includes('dave')) {
        $('#titleSlide').hide();
        $('#development').show();
        $('#submitDevelopment').click(function(){
            if ($('input[name = expLength]:checked').val() == 'short') {
                cycleThreshold = 2;
            }

            $('#development').hide();
            $('#titleSlide').show();
        });
    }

// button controls
$('#detail').click(function(){
    $('#titleSlide').hide();
    $('#detailSlide').show();
    vid.pause();
});

$('.resetTitle').click(function(){
    $('#titleSlide').show();
    $('#detailSlide').hide();
    $('#keyRemindSlide').hide();
});

$('#seeKeys').click(function(){
    if (instructionsReceived) {
        $('#keyRemindSlide').show();
        $('#titleSlide').hide();
        vid.pause();
    } else {
        vid.pause();
        alert('Please finish the video before continuing.');
    }
});

// if reading the text
// from here: https://stackoverflow.com/questions/6271237/detecting-when-user-scrolls-to-bottom-of-div-with-jquery
jQuery(function($){
    $('.textInstructionsContainer').on('scroll', function(){
        if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
            instructionsReceived = 1;
        }
    })
}); 

$('#seeKeysFromDetailSlide').click(function(){
    if (instructionsReceived) {
        $('#detailSlide').hide();
        $('#keyRemindSlide').show();
    } else {
        alert('Please read all of the instructions before clicking on the "See Controls" button.');
    }
});

$('#startSegment').click(function(){
    startSegment();
});


function startSegment() {

    $('#keyRemindSlide').hide();
    $('.keys').html(controlsString);
    $('.keys').hide();
    $('.choiceSlide').show();

    runTrial();

} // end startSegment()

function runTrial() {

    // control display
    $('.stimSlide').hide();
    $('.deckAttributeContainer').hide();
    $('.deckAttributeSeparator').hide();
    $('#leftDeckBottom').hide();
    $('#rightDeckBottom').hide();
    if (chosenDeckLocation) {
        $('#' + selectedOutcome['horizontal'] + 'Deck' + selectedOutcome['vertical']).removeClass('selectedAttribute').addClass('deSelectedAttribute');
    }
    $('.choiceSlide').show();

    // control between cycle condition update and counters
    if (cycleTrialCount == trialThreshold | cycleTrialCount == 0) {
        conditionOrder = createConditionOrder(ref=ref);
        cycleCount += 1;
        cycleTrialCount = 0;


        if (cycleCount > cycleThreshold) {
            endSegment();
            return
        }
    }

    // set condition and update counters
    currentCondition = conditionOrder[cycleTrialCount];

    cycleTrialCount += 1;
    trialCount += 1;
    direction = currentCondition['name'] == 'HE' || currentCondition['name'] == 'HM' ? 'Harder than Reference' : 'Easier than Reference';
    magnitude = currentCondition['name'] == 'HE' || currentCondition['name'] == 'EE' ? 'Extreme' : 'Moderate';

    // Get deck code that maps condition to decks
    // {'left': {'name:' 'risky', 'acc': {'top': .75, 'bottom': .55}}}
    deckCode = getDeckCode(currentCondition, ref);

    // fills deck html
    activeSeparator = updateDeckAttributes(deckCode);
    updateAttributeColors(deckCode, ref);

    // listen for space bar
    listen_for_spacebar('Choice');

    setTimeout(function(){
    
        // Control Display
        $('.deckAttributeContainer').show();
        $('#' + activeSeparator + 'DeckBottom').show();
        $('#' + activeSeparator + 'DeckAttributeSeparator').show();

        // start rt choice timer
        startTime = new Date();

        // listen for choice keys
        $(document).bind('keydown.listenForChoiceKeys', function(e){

            if ($.inArray(e.which, [81, 80]) + 1) {

                // record choice rt
                choiceRt = new Date() - startTime;

                // Get the location of choice
                chosenDeckLocation = e.which == 81 ? 'left' : 'right';

                // record choice key
                choiceResponseKey = e.which == 81 ? 'Q' : 'P';

                // stop listening for choice keys
                $(document).unbind('keydown.listenForChoiceKeys');

                // reset cued vars
                responseCount = 0;
                prevTaskColor = '';
                
                // determine outcome
                // {'pswitch': xx, 'horizontal': 'left', 'vertical': 'top'}
                selectedOutcome = determineOutcomePswitch(chosenDeckLocation, deckCode);

                // update difficulty parameters
                rt_window = get_rt_window(selectedOutcome['acc'], b0, b1);
                pswitch = get_pswitch(rt_window, b0, b1);
                console.log([selectedOutcome['acc'], b0, b1]);
                console.log([rt_window, pswitch]);

                // Draw box around selected outcome
                $('#' + selectedOutcome['horizontal'] + 'Deck' + selectedOutcome['vertical']).addClass('selectedAttribute').removeClass('deSelectedAttribute');

                setTimeout(function() {
                    // let them see the outcome before moving on
                    firstCuedTrial();
                }, 2000);

            } // end is response key valid?

        }) // end listenForChoiceKeys()

    }, choiceRsi); // end timeout

} // end runTrial()

function firstCuedTrial() {
    // set state
    state_new_cued_run();
    $('#fixationStim').show();

    setTimeout(function() {
        $('#fixationStim').hide();
        cuedTrial();
    }, 1000);
}

function cuedTrial() {

    // Generate stimulus

    currentTaskColor = generateTransition(pswitch, prevTaskColor);
    currentStim = generateCuedStim();
    currentTask = taskCueCode[currentTaskColor]
    
    // listen for space
    listen_for_spacebar('Cued');

    // set state
    state_new_cued_run(currentStim, currentTaskColor);

    // reset error
    error = 0;
    timeout = 0;

    // control rsi
    setTimeout(function(){
        
        // show stim
        $('#cuedStim').show();

        // start rt timer
        startTime = new Date();

        // start listening for keys
        $(document).bind('keydown.listenForResponseKeys', function(i){
            handle_response(i, timeout);
        });
                    
        response_timer = setTimeout(function() {
            timeout = 1;
            handle_response(0, timeout);
        }, rt_window);

    }, cuedRsi);
}

function handle_response(i, timeout) {
    // if response is valid
    if (timeout | $.inArray(i.which, [74, 75, 68, 70]) + 1) {

        // stop rt window
        clearTimeout(response_timer);

        // record cued rt
        if (timeout) {
            cuedRt = NaN;
        } else {
            cuedRt = new Date() - startTime;
        }

        // stop listening for keys
        $(document).unbind('keydown.listenForResponseKeys');

        // code error
        if (timeout) {
            error = 0;
        } else {
            error = cuedIsError(String(i.which), currentTask, currentStim);
        }

        // code transition
        transition = codeTransition(prevTaskColor, currentTaskColor);
        // update prev task color
        prevTaskColor = currentTaskColor;
        // update response count
        responseCount += 1;
        // record cued key
        cuedResponseKey = i.which == 74 ? 'J' : 'K';

        // record data
        saveTrialData()
        
        // start error sequence

        if (error | timeout) {
            // fill and supply error feedback
            if (error) {
                $('#errorContainer').show();
            } else {
                $('#timeoutContainer').show();
            }

            // wait 500 ms and prepare for next trial
            setTimeout(function(){
                $('#errorContainer').hide();
                $('#timeoutContainer').hide();

                // check whether run is over
                if (responseCount == responseThreshold) {
                    runTrial();
                } else {
                    cuedTrial();
                }


            }, 500) // end error timeout
        
        // if accurate response
        } else {

            // check whether run is over
            if (responseCount == responseThreshold) {
                runTrial();
            } else {
                cuedTrial();
            }

        } // end if accurate response

    } // end is response valid

} // end handle_response()


function saveTrialData() {

    if (deckCode['left']['name'] == 'riskyDeck') {
        var safeDeckSwitch = deckCode['right']['acc']['top'];
        var riskyDeckSwitch = [deckCode['left']['acc']['top'], deckCode['left']['acc']['bottom']];
    } else {
        var safeDeckSwitch = deckCode['left']['acc']['top'];
        var riskyDeckSwitch = [deckCode['right']['acc']['top'], deckCode['right']['acc']['bottom']];
    }

    var selectedRiskyDeck = 0;
    if (chosenDeckLocation == 'left' && deckCode['left']['name'] == 'riskyDeck') {
        selectedRiskyDeck = 1;
    } else if (chosenDeckLocation == 'right' && deckCode['right']['name'] == 'riskyDeck') {
        selectedRiskyDeck = 1;
    }

    trialStruct.push({
        'choiceTrial': trialCount,
        'cuedTrial': responseCount,
        'overalltrial': ((trialCount - 1) * 17) + responseCount,
        'experimentRunTimeMins': experimentStartTime ? Math.round((Date.now() - experimentStartTime) / 1000 / 60) : 'null',
        'phaseRunTimeMins': Math.round((Date.now() - phaseStartTime) / 1000 / 60),
        'stimulus': currentStim,
        'stimColor': currentTaskColor,
        'task': currentTask,
        'condition': currentCondition['name'],
        'magnitude': magnitude,
        'direction': direction,
        'cuedResponseKey': cuedResponseKey,
        'choiceResponseKey': choiceResponseKey,
        'transition': transition,
        'leftDeckId': deckCode['left']['name'],
        'rightDeckId': deckCode['right']['name'],
        'riskyDeckSwitchTop': riskyDeckSwitch[0],
        'riskyDeckSwitchBottom': riskyDeckSwitch[1],
        'safeDeckSwitch': safeDeckSwitch,
        'selectedDeckLocation': chosenDeckLocation,
        'acc_level_iv': selectedOutcome['acc'],
        'selectedRiskyDeck': selectedRiskyDeck,
        'error': error,
        'timeout': timeout,
        'chosenDeckId': deckCode[chosenDeckLocation]['name'],
        'choiceRt': choiceRt,
        'cuedRt': cuedRt
    });

}

function endSegment() {

    var curDate = new Date();
    var finishTime = new Date() - phaseStartTime;

    var currentData = {
        'subject': subject_id,
        'survey_code': survey_code,
        'curTime': curDate.today() + '@' + curDate.timeNow(),
        'userAgent': navigator.userAgent,
        'screenWidth': screen.width,
        'screenHeight': screen.height,
        'windowWidth': $(window).width(),
        'windowHeight': $(window).height(),
        'phase': phase,
        'blueTask': taskCueCode['blue'],
        'redTask': taskCueCode['red'],
        'phaseRunTime': finishTime,
        'corrected_effort_units': corrected,
        'trialStruct': trialStruct
    };

    sendToServer(subject_id, currentData);

} // end endSegment()

function sendToServer(subject_id, currentData) {

    var dataToServer = {
        'curId': subject_id,
        'experiment': experimentName,
        'sessionCode': phase,
        'currentData': JSON.stringify(currentData)
    };

    var urlArgs = {
        'subject-code': subject_id,
        'survey-code': survey_code,
        'taskCueCode': taskCueCode,
        'corrected': corrected,
        'experimentStartTime': experimentStartTime
    };

    $.post(
        url = 'https://davebraun.net/cgi-bin/saveData.py',
        data = dataToServer,
        success = function(data){
            window.location.replace('../rapidFire/?' + $.param(urlArgs));
        }).fail(function(data){
            console.log('FAILURE');
            window.location.replace('../rapidFire/?' + $.param(urlArgs));
        });

} // end sendToServer()


}); // end document.ready()

</script>

</head>

<body>

<!-- the entire display -->
<div class='container'>
    <!-- the 800 x 600 experiment area -->
    <div class='screen'>

        <!-- BEGIN DEVELOPMENT SLIDE -->
            <div id='development'>
                <p>You've entered the extra secret 'secret code'. This must mean Dave has given you permission to pilot. Do you want to do the full length phase, or a shortened one?</p>
                <input type='radio' name='expLength' value='regular' checked>Regular<br>
                <input type='radio' name='expLength' value='short'>Shortened<br>
                <button id='submitDevelopment' class='experimentButton'>Submit</button>
            </div>

        <!-- BEGIN TITLE SLIDE -->
            <div id='titleSlide'>
                <div class='titleBar'>
                    <h2>You are about to begin the main experiment.</h2>
                </div>

                <div class='leftTwoThirds'>
                    <p>That is it for the practice. The next phase will run throughout most of the rest of the experiment (about 25 min). Watch the video below to get final instructions before beginning. <i class='small'>(Runtime: 2 min 57 sec)</i>.</p><br>
                    <p class='small'>If you don't have speakers, you can click "See Text Instructions" to read the instructions in text form.</p>

                
                    <video id='tutorial' width='510' height='290' controls>
                        <source src = "exp3Dst.mp4" type = "video/mp4">
                    </video>
                

                </div>

                <div class='rightOneThirdsDown'>
                    <button id='detail' class='experimentButton center smallButton'>See Text Instructions</button>
                    <button id='seeKeys' class='experimentButton center'>See Controls</button>
                </div>
            </div> <!-- end title slide -->

        <!-- BEGIN DETAIL SLIDE -->
        <div id='detailSlide'>
            <div class='textInstructionsContainer'>
            <p>In that last practice phase, you switched between tasks 8 times out of every 17 responses. We’ve had a lot of people take this study, and most people would say that’s about a medium level of difficulty. If we thought about difficulty as being on a 0 to 100 scale, for example, then what you did would be about a 50. But maybe it’s not intuitive to think about mental effort in terms of units, so we can think about lifting weights instead, for example. Let’s pretend 50 is a moderate amount of weight and it’s comfortable. Somebody’s used to it, and they feel good doing it. If you go higher than 50 and increase the effort units, that feels strenuous and it’s tough. And if you go lower than 50, that feels easier and it feels good. Throughout these next parts of this experiment, we’ll be talking about the difficulty of these tasks in terms of effort units, and you can know that 50 is what you just did in practice---that’s about a medium amount of difficulty. You’ll be doing more responses at 50 (medium), you’ll be doing some responses which have higher units (which mean they’re harder), and some with fewer effort units (which mean they’re easier). For the rest of the experiment, you'll be choosing between two decks of cards on the screen. The "D" key selects the left deck, the "F" key selects the right deck. Each time you select a deck, a card will be flipped upwards, and you'll use the "J" and "K" keys to perform the same types of simple judgments that you performed in that last practice phase. Each time you select a deck, you'll draw 17 cards from that deck, so you'll be performing this simple judgment 17 times, just like you did in the practice round. However, this time, the number of switches you'll be doing in a run will be determined by the effort units that you will see on the front of the decks. High effort units means you'll be doing a lot of switching and it'll be hard; lower effort units means fewer switching, which means it'll be easier. We've displayed the absolute number of effort units on the deck, as well as the difference in how far the effort units are from fifty (displayed in parentheses). Each time you select a deck, a black box will appear around one of the effort units on the deck, and that tells you how difficult the upcoming run is going to be. Each time you select between decks, there's one deck that we can call a "safe" deck, because it only has one possible outcome. So you'll know how many effort units the upcoming run would have if you were to choose this deck. Additionally, each time you choose, there's going to be what we can call a "risky" deck, because it has two possible outcomes. If you were to choose this deck, there's a 50% chance of getting one of the outcomes, and a 50% chance of getting the other outcome. So, after selecting this deck, it's like flipping a coin to determine the number of effort units for the upcoming run of trials. This phase will run throughout pretty much the rest of the experiment, so probably about 25 min. When you're ready to begin this phase you can press the "See Controls" button below to see your controls before beginning.</p>
        </div>

            <div class='rightOneThirdsDown'>
                <button class='experimentButton resetTitle smallButton textInstructionsButtons'>Go Back</button>
                <button class='experimentButton textInstructionsButtons' id='seeKeysFromDetailSlide'>See Controls</button>
            </div>
        </div> <!-- end detail slide -->


        <!-- BLOCK TRANSITION SLIDE -->
        <div id='blockTransitionSlide'>
            <div class='titleBar'>
            </div>

            <div class='leftTwoThirds' id='blockInstructions'>
            </div>

            <div class='rightOneThirdsDown'>
                <button class='experimentButton center' id='startBlock'>Continue</button>
            </div>
        </div> <!-- end block transition slide -->

        <!-- KEY REMIND SLIDE -->
        <div id='keyRemindSlide'>
            <div class='titleBar'>
                <p>Here are your controls. Remember, you can see this information at any point by holding down the space bar.</p>
            </div>

            <div class='leftTwoThirds' id='controlsFill'>
            </div>

            <div class='rightOneThirdsDown'>
                <button class='resetTitle experimentButton smallButton center'>Go Back</button>
                <button id='startSegment' class='experimentButton center'>Begin Phase</button>
            </div>
        </div> <!-- end key remind slide -->

        <div class='choiceSlide'>
            <div class='feedbackContainer'>
                <!--<div class='feedbackLevelOne'>
                    <div class='bonusFeedback'>
                    </div>
                </div> -->

                <div class='feedbackLevelTwo'>
                    <div id='keyToggleChoice' class='keyFormat keys'>
                    </div>
                </div>

            </div>
            

            <div class='topHalf'>
            
            </div> <!-- end top half -->

            <div class='bottomHalf'>
                <div class='deckOutline' id='leftDeck'>
                    <div class='deckAttributeContext'>
                        <p>Effort Units:</p>
                    </div>
                    <div class='deckAttributeContainer'>
                        <div class='deckAttribute' id='leftDeckTop'>
                        </div>
                        <div class='deckAttributeSeparator' id='leftDeckAttributeSeparator'>
                            <p>OR</p>
                        </div>                                   
                        <div class='deckAttribute' id='leftDeckBottom'>
                        </div>
                    </div>
                </div>

                <div class='deckOutline' id='rightDeck'>
                    <div class='deckAttributeContext'>
                        <p>Effort Units:</p>
                    </div>
                    <div class='deckAttributeContainer'>
                        <div class='deckAttribute' id='rightDeckTop'>
                        </div>
                        <div class='deckAttributeSeparator' id='rightDeckAttributeSeparator'>
                            <p>OR</p>
                        </div>                                   
                        <div class='deckAttribute' id='rightDeckBottom'>
                        </div>
                    </div>
                </div>
            </div> <!-- end bottom half -->


        </div> <!-- end choiceSlide -->

    <!-- start cued slide -->
    <div class='stimSlide'>
        <!-- html filled from js -->
        <div class='keyContainer keys' id = 'keyToggleCued'>
        </div>

        <div class='errorContainer' id='errorContainer'>
            <p><strong>ERROR!</strong></p>
        </div>

        <div class='errorContainer' id='timeoutContainer'>
            <p><strong>TIMEOUT!</strong</p>
        </div>

        <div class='stimContainer' id='cuedStim'>
        </div>

        <div class='stimContainer' id='fixationStim'>
            <p>+</p>
        </div>
    </div> <!-- end cued slide -->


    </div> <!-- end screen -->

</div> <!-- end container -->


</body>
</html>
